# User Service - Architecture & Flow Diagrams

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API GATEWAY                              â”‚
â”‚                    (Routes HTTP Requests)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ HTTP/REST
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USER SERVICE (Port 8000)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Django REST Framework                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚   Auth     â”‚  â”‚  Profile   â”‚  â”‚  Preferences   â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ Endpoints  â”‚  â”‚ Endpoints  â”‚  â”‚   Endpoints    â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚           â”‚                          â”‚
â”‚                           â–¼           â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Business Logic Layer                       â”‚    â”‚
â”‚  â”‚  â€¢ User Management  â€¢ Caching  â€¢ Validation            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚                  â”‚
         â”‚                      â”‚                  â”‚
         â–¼                      â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚   â”‚      Redis      â”‚   â”‚    RabbitMQ      â”‚
â”‚   (Database)    â”‚   â”‚     (Cache)     â”‚   â”‚  (push.queue)    â”‚
â”‚                 â”‚   â”‚                 â”‚   â”‚                  â”‚
â”‚ â€¢ Users         â”‚   â”‚ â€¢ Preferences   â”‚   â”‚ â–² Consumes      â”‚
â”‚ â€¢ Preferences   â”‚   â”‚ â€¢ Reset Tokens  â”‚   â”‚ â”‚ Messages      â”‚
â”‚ â€¢ Idempotency   â”‚   â”‚ â€¢ Rate Limits   â”‚   â”‚ â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  RabbitMQ Consumer     â”‚
                â”‚  (Background Worker)   â”‚
                â”‚                        â”‚
                â”‚  â€¢ Process Messages    â”‚
                â”‚  â€¢ Circuit Breaker     â”‚
                â”‚  â€¢ Retry Logic         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Request Flow - User Registration

```
Client                API Endpoint           Database            Cache
  â”‚                        â”‚                     â”‚                â”‚
  â”‚  POST /api/v1/users/   â”‚                     â”‚                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                â”‚
  â”‚                        â”‚                     â”‚                â”‚
  â”‚                        â”‚  1. Validate Input  â”‚                â”‚
  â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                â”‚
  â”‚                        â”‚         â”‚           â”‚                â”‚
  â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                â”‚
  â”‚                        â”‚                     â”‚                â”‚
  â”‚                        â”‚  2. Hash Password   â”‚                â”‚
  â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                â”‚
  â”‚                        â”‚         â”‚           â”‚                â”‚
  â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                â”‚
  â”‚                        â”‚                     â”‚                â”‚
  â”‚                        â”‚  3. Create User     â”‚                â”‚
  â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
  â”‚                        â”‚                     â”‚                â”‚
  â”‚                        â”‚  4. Create Prefs    â”‚                â”‚
  â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
  â”‚                        â”‚                     â”‚                â”‚
  â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
  â”‚                        â”‚                     â”‚                â”‚
  â”‚                        â”‚  5. Generate JWT    â”‚                â”‚
  â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                â”‚
  â”‚                        â”‚         â”‚           â”‚                â”‚
  â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                â”‚
  â”‚                        â”‚                     â”‚                â”‚
  â”‚                        â”‚  6. Cache Prefs     â”‚                â”‚
  â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                        â”‚                     â”‚                â”‚
  â”‚  201 Created           â”‚                     â”‚                â”‚
  â”‚  + User Data           â”‚                     â”‚                â”‚
  â”‚  + JWT Tokens          â”‚                     â”‚                â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                â”‚
  â”‚                        â”‚                     â”‚                â”‚
```

## ğŸ” Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚                                     â”‚  User Serviceâ”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                                 â”‚
      â”‚  1. POST /api/v1/auth/login/                   â”‚
      â”‚    {email, password}                            â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                                                 â”‚
      â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                                        â”‚ Authenticate    â”‚
      â”‚                                        â”‚ - Verify Email  â”‚
      â”‚                                        â”‚ - Check Passwordâ”‚
      â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                                 â”‚
      â”‚  2. 200 OK                                     â”‚
      â”‚     {access_token, refresh_token, user}        â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚                                                 â”‚
      â”‚  3. Use Access Token for Requests              â”‚
      â”‚     Authorization: Bearer <access_token>       â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                                                 â”‚
      â”‚  4. Response with Data                         â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚                                                 â”‚
      â”‚  (After token expires)                         â”‚
      â”‚                                                 â”‚
      â”‚  5. POST /api/v1/auth/refresh/                 â”‚
      â”‚     {refresh_token}                             â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                                                 â”‚
      â”‚  6. New Access Token                           â”‚
      â”‚     {access_token, refresh_token}              â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚                                                 â”‚
```

## ğŸ“¨ RabbitMQ Message Processing Flow

```
Push Service          RabbitMQ           Consumer           Cache/DB
     â”‚                   â”‚                   â”‚                 â”‚
     â”‚  1. Publish       â”‚                   â”‚                 â”‚
     â”‚  {notification}   â”‚                   â”‚                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                 â”‚
     â”‚                   â”‚                   â”‚                 â”‚
     â”‚                   â”‚  2. Queue Message â”‚                 â”‚
     â”‚                   â”‚   (push.queue)    â”‚                 â”‚
     â”‚                   â”‚                   â”‚                 â”‚
     â”‚                   â”‚  3. Consume       â”‚                 â”‚
     â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
     â”‚                   â”‚                   â”‚                 â”‚
     â”‚                   â”‚                   â”‚  4. Get User    â”‚
     â”‚                   â”‚                   â”‚  Preferences    â”‚
     â”‚                   â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                   â”‚                   â”‚                 â”‚
     â”‚                   â”‚                   â”‚  5. Return Data â”‚
     â”‚                   â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                   â”‚                   â”‚                 â”‚
     â”‚                   â”‚                   â”‚  6. Validate:   â”‚
     â”‚                   â”‚                   â”‚  - Push enabled?â”‚
     â”‚                   â”‚                   â”‚  - Token exists?â”‚
     â”‚                   â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
     â”‚                   â”‚                   â”‚         â”‚       â”‚
     â”‚                   â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
     â”‚                   â”‚                   â”‚                 â”‚
     â”‚                   â”‚                   â”‚  7. Enhance     â”‚
     â”‚                   â”‚                   â”‚  Message        â”‚
     â”‚                   â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
     â”‚                   â”‚                   â”‚         â”‚       â”‚
     â”‚                   â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
     â”‚                   â”‚                   â”‚                 â”‚
     â”‚                   â”‚  8. ACK Message   â”‚                 â”‚
     â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
     â”‚                   â”‚                   â”‚                 â”‚
     â”‚                   â”‚  (or NACK if error)                â”‚
     â”‚                   â”‚                   â”‚                 â”‚
```

## ğŸ”„ Circuit Breaker Pattern

```
Request â”€â”€> Circuit Breaker â”€â”€> RabbitMQ
                  â”‚
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚
      CLOSED            OPEN
         â”‚                 â”‚
         â”‚                 â”‚
    All requests      Fail fast
    pass through      (no attempts)
         â”‚                 â”‚
         â”‚                 â””â”€â”€> Wait timeout
         â””â”€â”€> Track              (60 seconds)
              failures               â”‚
                  â”‚                  â”‚
                  â”‚                  â–¼
                  â”‚            HALF-OPEN
                  â”‚                 â”‚
                  â”‚                 â”‚
                  â”‚            Test with
                  â”‚            one request
                  â”‚                 â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   If successful,
                   return to CLOSED

States:
â€¢ CLOSED: Normal operation (0-4 failures)
â€¢ OPEN: Circuit tripped (5+ failures), fails fast
â€¢ HALF-OPEN: Testing if service recovered
```

## ğŸ’¾ Caching Strategy

```
Request for User Preferences
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Check Cache  â”‚
    â”‚  (Redis)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€ Cache Hit â”€â”€> Return Data (fast)
           â”‚
           â””â”€â”€â”€ Cache Miss
                   â”‚
                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Query DB     â”‚
            â”‚ (PostgreSQL) â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Store in     â”‚
            â”‚ Cache        â”‚
            â”‚ (TTL: 1hr)   â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
              Return Data

Cache Invalidation:
â€¢ User updates preferences -> Delete cache key
â€¢ User updates profile -> Delete cache key
â€¢ Token expires -> Auto-expire (1 hour TTL)
```

## ğŸ” Retry Pattern with Exponential Backoff

```
Message Processing Attempt
           â”‚
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Process  â”‚
     â”‚ Message  â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
   â”‚             â”‚
Success        Failure
   â”‚             â”‚
   â–¼             â–¼
 ACK      Retry Count < 3?
Message        â”‚
          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
          â”‚         â”‚
         Yes        No
          â”‚         â”‚
          â–¼         â–¼
     Wait 2^n    Move to
     seconds    Dead Letter
          â”‚      Queue
          â–¼
     NACK +
     Requeue

Backoff Times:
â€¢ Attempt 1: Immediate
â€¢ Attempt 2: Wait 2 seconds
â€¢ Attempt 3: Wait 4 seconds
â€¢ Attempt 4: Wait 8 seconds
â€¢ Then: Dead Letter Queue
```

## ğŸ¯ Idempotency Pattern

```
Client Request with X-Request-ID
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Check Idempotencyâ”‚
    â”‚ Key in Database  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
      â”‚             â”‚
   Exists      Not Exists
      â”‚             â”‚
      â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check    â”‚  â”‚ Process  â”‚
â”‚ Expiry   â”‚  â”‚ Request  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚             â”‚
     â”œâ”€Expired     â”‚
     â”‚             â–¼
     â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚       â”‚ Store    â”‚
     â”‚       â”‚ Response â”‚
     â”‚       â”‚ (24hrs)  â”‚
     â”‚       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€> Return Response

Benefits:
â€¢ Prevents duplicate operations
â€¢ Safe retries
â€¢ Consistent responses
â€¢ 24-hour window
```

## ğŸ“Š Database Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             users                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID) PK                        â”‚
â”‚ email (String) UNIQUE INDEX         â”‚
â”‚ name (String)                       â”‚
â”‚ password (String) HASHED            â”‚
â”‚ push_token (String) NULL            â”‚
â”‚ preferences_id (UUID) FK            â”‚
â”‚ email_verified (Boolean)            â”‚
â”‚ email_verification_token (String)   â”‚
â”‚ is_active (Boolean)                 â”‚
â”‚ is_staff (Boolean)                  â”‚
â”‚ is_superuser (Boolean)              â”‚
â”‚ created_at (DateTime) INDEX         â”‚
â”‚ updated_at (DateTime)               â”‚
â”‚ last_login (DateTime)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ 1:1
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        user_preferences             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID) PK                        â”‚
â”‚ email (Boolean) DEFAULT TRUE        â”‚
â”‚ push (Boolean) DEFAULT TRUE         â”‚
â”‚ created_at (DateTime)               â”‚
â”‚ updated_at (DateTime)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      idempotency_keys               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID) PK                        â”‚
â”‚ request_id (String) UNIQUE INDEX    â”‚
â”‚ endpoint (String)                   â”‚
â”‚ response_data (JSON)                â”‚
â”‚ status_code (Integer)               â”‚
â”‚ created_at (DateTime)               â”‚
â”‚ expires_at (DateTime) INDEX         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸŒ API Response Structure

```json
{
  "success": true|false,
  "message": "Human readable message",
  "data": {
    // Actual response data
  },
  "meta": {  // Optional, for paginated responses
    "total": 100,
    "limit": 20,
    "page": 1,
    "total_pages": 5,
    "has_next": true,
    "has_previous": false
  },
  "error": "Error message if success=false"
}
```

## ğŸ” Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Client Request                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  HTTPS/TLS      â”‚
         â”‚  (SSL Layer)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  CORS Check     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Rate Limiting  â”‚
         â”‚  (Redis)        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  JWT Validation â”‚
         â”‚  (if required)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Input          â”‚
         â”‚  Validation     â”‚
         â”‚  (Serializers)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Business Logic â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Database       â”‚
         â”‚  (Parameterized â”‚
         â”‚   Queries)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

These diagrams provide a visual overview of how the user service operates and integrates with other components of the system.
